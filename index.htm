<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<link REL="SHORTCUT ICON" HREF="img/UVALogo.ico">
	<title>VisualEyes</title>
 	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>	
	<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css" />
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
	<script src="jquery.ui.touch-punch.min.js"></script>
  	<link rel="stylesheet" href="http://openlayers.org/en/v3.5.0/css/ol.css" type="text/css">
   	<script src="http://openlayers.org/en/v3.5.0/build/ol-debug.js" type="text/javascript"></script>
  	<script type="text/javascript" src='//www.google.com/jsapi?autoload={"modules":[{"name":"visualization","version":"1"}]}'></script>
	<script src="space.js" type="text/javascript"></script>
  	<script src="time.js" type="text/javascript"></script>
  	<script src="popup.js" type="text/javascript"></script>
  	<script src="data.js" type="text/javascript"></script>
 
 	<style type="text/css">
		body { 				font-family:Verdana,Geneva,sans-serif; font-size:9px; 
							padding:0px;margin:0px;
							}
		.popup-main	{ 		position:absolute;padding:12px;border-radius:6px;display:none; 
							border:1px solid #999;background-color:#fff;font-size:11px;
							overflow-x:hidden;max-height:100px;max-width:300px;
							}
		.popup-pic { 		margin-right:8px;vertical-align:top;cursor:zoom-in;
							border:1px solid #999;width:80px;
							}				
		.popup-desc { 		vertical-align:top;color:#555;cursor:zoom-in;
							}				
		.popup-title {		margin-bottom:8px;color:#555;
							}
		.popup-date { 		color:#999;font-size:9px;
							}
		.time-timebar { 	position:absolute;color:#999;
							}
		.time-seg { 		position:absolute;height:14px;text-align:center;padding-top:2px;
		  					white-space:nowrap;overflow:hidden;cursor:pointer; 
							}
		.time-startend {	font-size:11px;font-weight:bold;color:#666;
							}
		.time-timeslider {	background:#ccc;height:6px;border:none;display:inline-block;
							}
		.time-timeslider.ui-slider .ui-slider-handle {
							height:30px;width:8px;margin-top:-8px;
							background:#009900;border:none;cursor:pointer;
							}
		.time-slidertime { 	position:absolute;width:100px;text-align:center;
							}
		.time-ticks { 		position:absolute;width:2px;height:8px;background-color:#ccc;
							}
		.time-ticklabel { 	position:absolute;width:100px;text-align:center;color:#999
							}
		.time-timeplayer { 	position:absolute;color:#999;margin-left:18px;margin-right:18px;width:123px;
							}

		.time-playerslider{ background:#ccc;height:4px;width:80px;border:none;display:inline-block;
							margin-left:6px;
							}
		.time-playerspeed { position:absolute;width:40px;text-align:center;font-size:9px;color:#999;
							}
		.time-playerslider.ui-slider .ui-slider-handle {
							height:0px;width:0px;margin-top:7px;cursor:pointer;
							border-left: 5px solid transparent;border-right: 5px solid transparent;
							border-bottom: 8px solid #999;
							}
		.time-timeview { 	position:absolute;color:#666;overflow:hidden;width:100%;
							}
		.ve-unselectable { 	-moz-user-select: none;     -khtml-user-select: none;
		   			 		-webkit-user-select: none;  	-ms-user-select: none;   user-select: none;
							}
		.ve-base { 			position:absolute;height:100%;width:100%;
							}	
		.ve-left { 			}	
		.ve-right { 		background-color:#eee;overflow-y:auto;
							}	
		.ve-bottom { 		background-color:#f8f8f8;width:100%;
							}	
		.ve-splash { 		text-align:center;vertical-align:center;pointer-events:none;
							}
		.ve-is {			border-radius:10px;padding-left:8px;padding-right:8px;padding-top:1px;
							border:1px solid #999;font-size:12px;height;20px;width:200px;
							}
		.ve-bs {			border-radius:10px;padding-left:8px;padding-right:8px;padding-top:1px;
							border:1px solid #999;font-size:12px;height;20px;color:#666;
							}

 	</style>

</head>
<body>
<div id="showDiv" style="opacity:0" class="ve-base">
	<div id="bottomDiv" style="position:absolute;top:0px;opacity:inherit" class="ve-bottom ve-unselectable">
		<img id="settingsBut" src="img/settingsbut.gif" style="position:absolute;cursor:pointer">
	</div>
	<div id="leftDiv" style="position:absolute;opacity:inherit" class="ve-left"></div>
	<div id="rightDiv" style="position:absolute;opacity:inherit" class="ve-right"></div>
	<div id="lrSiz" style="position:absolute;width:8px;cursor:col-resize;opacity:inherit" class="ve-unselectable" title="Resize panes">
		<div id="lrSiz1" style="position:absolute;width:40px;height:100%;left:-8px" class="ve-unselectable"></div>
	</div>
	<div id="bSiz" style="position:absolute;height:8px;width:100%;cursor:row-resize;opacity:inherit" class="ve-unselectable" title="Resize timeline">
		<div id="bSiz1" style="position:absolute;height:20px;width:100%" class="ve-unselectable"></div>
	</div>
</div>
<div id="splashDiv" class="ve-splash"><img src="img/velogo.png"></div>
<script>

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// DISPLAY
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	var sd={},mps={},tln={},pop={},dtl={};
	var paneAnimationTimer=null;												// Times pane animations
	var imageAnimationTimer=[];													// Times image animations
	var isMobile=false;															// Flag for mobile devices
	var host="//viseyes.org/";													// Set host
	var userName="",password="",curShow=0;										// Login info
	var lastClickTime=0;														// Store last click time
	var drupalMan=false;														// Flag for drupal manager	
	var curSpanStart,curSpanEnd,curTime;
	
	function ResizePanes()													// RESIZE PANES
	{ 
		var wid=$("#showDiv").width();											// Width
		var hgt=$("#showDiv").height();											// Height
		var cx=wid*sd.leftRightSplit;											// Center
		var cy=hgt*sd.upDownSplit;												// Center
		$("#leftDiv").width(cx);												// Set left width
		$("#rightDiv").width(wid-cx);											// Set right width
		$("#rightDiv").css("left",cx+"px");										// Set right pos
		$("#leftDiv").height(cy);												// Set left height
		$("#rightDiv").height(hgt);												// Set right height
		$("#lrSiz").css("left",cx+"px");										// Set lr size pos
		$("#lrSiz").height(hgt);												// Set lr size height
		$("#bSiz").css("top",cy+"px");											// Set b size pos
		$("#bSiz").width(cx);													// Set b size width
		$("#bottomDiv").width(cx);												// Set bottom width
		$("#bottomDiv").height(hgt-cy);											// Set bottom height
		$("#bottomDiv").css("top",cy+"px");										// Set lr size pos
		$("#settingsBut").css({ top:$("#bottomDiv").height()-18,left:cx-18});	// Settings button
		mps.UpdateMapSize();													// Update map size to div size
		tln.UpdateTimeline();													// Update timeline to div size
		Draw();																	// Redraw
}		


	function InitProject(data)												// INIT PROJECT
	{
		var i,s,e,v,t,id;
		sd.timeSegments=null;													// Assume no segments
		if (data)		sd=data;												// If data, set it
		if (!sd.mobs)	sd.mobs=[];												// Alloc if empty
		mps.ClearLayers();														// Clar all layera
		if (!data) {			
			
			sd.sheet="";
			sd.upDownSplit=.75;
			sd.leftRightSplit=.66;													
			
			var o={};
			o.mapMarker="//www.viseyes.org/visualeyes/projects/WinchesterMap.jpg";
			o.start="1862";
			o.end="1889";
			o.where="39.228788398479615,39.149512265542775,-78.09690370109803,-78.19686447861471,0";
			sd.mobs.push(o);

			o={};
			o.mapMarker="projects/ConfederateStates.kml";
			o.start="4/12/1861";
			o.end="6/22/1865";
			o.show="se";
			o.opacity=.15;
			o.id="NS-map"
			sd.mobs.push(o);

			o={};
			o.marker="Path";
			o.desc="born,ny,preach,sermon";
			o.color="#990000";
			o.id="journey";
			o.size=5;
			o.opacity=.5;
			o.end="1922";
			o.show="a";
			sd.mobs.push(o);

			o={};
			o.marker="Star";
			o.start="1/12/1862";
			o.where="-78.16,39.19,20,0";
			o.title="Robinson born";
			o.desc="JW Robinson is born in Winchester, VA";
			o.pic="//www.viseyes.org/visualeyes/projects/Robinson.jpg";
			o.goto="-78.16,39.19,3";
			o.color="#ff9900";
			o.edge="#666";
			o.id="born";
			o.row=1;
			sd.mobs.push(o);
	
			o={};
			o.marker="Square";
			o.start="6/8/1886";
			o.where="-74.0,40.71,20,0";
			o.title="Moves to New York";
			o.desc="Robinson moves to New York";
			o.pic="http://www.artvalue.com/photos/auction/0/50/50908/mcnulty-william-c-1889-1963-us-towers-in-the-sky-new-york-3005289.jpg";
			o.color="#ff9900";
			o.edge="#666";
			o.id="ny";
			o.row=2;
			sd.mobs.push(o);

			o={};
			o.marker="Line";
			o.start="4/12/1861";
			o.end="6/22/1865";
			o.desc="<b>The American Civil War</b>, widely known in the United States as simply the Civil War as well as other sectional names, was a civil war fought from 1861 to 1865 to determine the survival of the Union or independence for the Confederacy.<br><br>Among the 34 states in January 1861, seven Southern slave states individually declared their secession from the United States and formed the Confederate States of America. The Confederacy, often simply called the South, grew to include eleven states, and although they claimed thirteen states and additional western territories, the Confederacy was never diplomatically recognized by a foreign country. The states that remained loyal and did not declare secession were known as the Union or the North.<br><br>The war had its origin in the fractious issue of slavery, especially the extension of slavery into the western territories.[N 1] After four years of combat, which left over 600,000 Union and Confederate soldiers dead and destroyed much of the South's infrastructure, the Confederacy collapsed and slavery was abolished. Then began the Reconstruction and the processes of restoring national unity and guaranteeing civil rights to the freed slaves.";
			o.pic="http://www.suvcw.org/wp-content/uploads/2013/12/cannon.jpg";
			o.goto="-89.0751,33.147,5000";
			o.title="Civil War";
			o.color="#d63333";
			o.click="show:NS-map";
			o.row=5;
			sd.mobs.push(o);

			o={};
			o.marker="Dot";
			o.start="6/1891";
			o.where="-78.47,38.03,20,0";
			o.title="Preaches";
			o.desc="Robinson preaches on \"The Sin of the Modern Dance.\" Makes flying visit to Warm Sulphur & Hot Springs; preaches to white and colored";
			o.pic="http://i234.photobucket.com/albums/ee268/solomon_042/SLAVRELIGION.jpg";
			o.color="#ff9900";
			o.edge="#666";
			o.id="preach";
			o.row=3;
			sd.mobs.push(o);

			o={};
			o.marker="Dot";
			o.start="5/16/1907";
			o.where="-86.15,39.76,20,0";
			o.title="Publishes sermon";
			o.desc="Robinson publishes sermon synopsis, \"Peacocks and Apes,\" with antilynching commentary";
			o.pic="http://www.mtholyoke.com/pcsite/books/images10/Sermon01.jpeg";
			o.color="#ff9900";
			o.edge="#666";
			o.id="sermon";
			o.row=4;
			sd.mobs.push(o);

			o={};
			o.marker="Segment";
			o.start="1/1860";
			o.end="1886";
			o.title="Winchester";
			o.click="where:-78.16,39.19,3";
			o.color="#ccc";
			sd.mobs.push(o);
			o={};
			
			o={};
			o.marker="Segment";
			o.start="1886";
			o.end="1889";
			o.title="New York";
			o.click="where:-74.0,40.71,300";
			o.color="#ccc";
			sd.mobs.push(o);
			
			o={};
			o.marker="Segment";
			o.start="1889";
			o.end="1898";
			o.title="Charlottesville";
			o.click="where:-78.47,38.03,300";
			o.color="#ccc";
			sd.mobs.push(o);
			
			o={};
			o.marker="Segment";
			o.start="1898";
			o.end="1902";
			o.title="Boston";
			o.click="where:-80.00,38.41,1500";
			o.color="#ccc";
			sd.mobs.push(o);
	
			o={};
			o.marker="Segment";
			o.start="1902";
			o.end="1906";
			o.title="Connecticut";
			o.click="where:-80.00,38.41,1500";
			o.color="#ccc";
			sd.mobs.push(o);
			
			o={};
			o.marker="Segment";
			o.start="1906";
			o.end="1910";
			o.title="Indiana";
			o.click="where:-86.15,39.76,300";
			o.color="#ccc";
			sd.mobs.push(o);
		
			o={};
			o.marker="Segment";
			o.start="1910";
			o.end="12/1922";
			o.title="Traveling";
			o.click="where:-80.00,38.41,1500";
			o.color="#ccc";
			sd.mobs.push(o);

			sd.mapTextCol="#ffffff";
			sd.mapTextFont="bold 12px sans-serif ";
			sd.baseMap="Roadmap";
			sd.timeFormat="Mon Year";
			sd.start="1/1860";
			sd.end="12/1922";
			sd.muteSound=false;
			}

		for (i=0;i<sd.mobs.length;++i) {									// For each mob	
			o=sd.mobs[i];													// Point at mob
			if (o.start)	o.start=pop.DateToTime(o.start);				// Convert date to time
			if (o.end)		o.end=pop.DateToTime(o.end);					// Convert date to time
			s=e=0;															// Assume not timed
			if (o.show) {													// If show mode spec'd
				if (o.show.match(/s/i)) 	s=o.start;						// Start timed
				if (o.show.match(/e/i)) 	e=o.end;						// End timed
				if (o.show.match(/off/i)) 	s=e=-1;							// Hide it
				}
			if (o.marker || o.mapMarker) {									// If a marker spec'd 
				var marker=o.mapMarker ? o.mapMarker : o.marker;			// Use mapMarker first, then marker
				o.type="icon";												// Assume icon
				if (marker.match(/drive\.google/i)) {						// An drive file
					o.type="kml";											// Set type
					id=marker.match(/id=(.+)&/);							// Extract id
					if (id)	{												// An id found
						var s="//drive.google.com/uc?export=view&id="+id[1];// Construct 'direct' link
						o.lid=mps.AddKMLLayer(s,o.opacity,s,e);				// Add KML layer								 
						}
					}
				else if (marker.match(/\.kml/i)) {							// A KML file
					o.type="kml";											// Set type
					o.lid=mps.AddKMLLayer(marker,o.opacity,s,e);			// Add KML layer								 
					}
				else if (marker.match(/path/i)) {							// A path
					var dots=[];
					o.type="path";											// Set type
					v=o.desc.split(",");									// Split by comma
					for (j=0;j<v.length;++j) {								// For each one spec'd
 						id=sd.mobs[FindMobByID(v[j])];						// Point at mob
 						if ((id == undefined) || (id < 0))					// Mob not found
 							continue;										// Skip it
 						t=id.start;											// Get time
  						t=pop.DateToTime(t);								// +/- min past 1970
						if (!j)		s=e=t;									// Init to 1st mob
						vv=id.where.split(",");								// Split into parts
						vv=ol.proj.transform([vv[0]-0,""+vv[1]-0],'EPSG:4326',mps.curProjection);	// Transform 
						vv.push(t); 										// Add time
						dots.push(vv);										// Add dot
						s=Math.min(s,t);									// Earliest
						e=Math.max(e,t);									// Latest
						}
					var ew=o.size ? o.size  : 2;							// Set size with 2 pixel default
					var eo=o.opacity ? o.opacity  : 1;						// Set opacity with 1.0 default
					mps.AddPathLayer(dots,o.color,ew,eo,s,o.end ? o.end: e, o.show);// Add path to overlays
					}
				else if (marker.match(/\.png|.gif|\.jpg|\.jpeg/i) && o.where) { // An image file
					o.type="image";											// Set type
					o.lid=mps.AddImageLayer(marker,o.where, o.opacity,s,e);	// Add image layer								 
					}
				else if (marker.match(/segment/i)) {						// A segment
					var oo={};												
					o.type="segment";										// Set type
					if (!sd.timeSegments)	sd.timeSegments=[];				// Alloc new array if not already there
					oo.start=o.start;		oo.end=o.end;					// Start, end
					oo.title=o.title;		oo.col=o.color;					// Title, color
					oo.click=o.click;										// Click
					sd.timeSegments.push(oo);								// Add seg
					}
				else if (marker.match(/init/i)) {							// An init
					o.type="init";											// Set type
					}
				else if (o.where) { 										// Must be an icon
					var sty={};												// Not style
					o.type="icon";											// Set type
					o.mapMarker ?	sty.m=o.mapMarker : sty.m=o.marker;		// Use map marker first, then time marker
					o.mapTitle  ?	sty.t=o.mapTitle  : sty.t=o.title;			
					o.mapDesc   ?	sty.d=o.mapDesc   : sty.d=o.desc;				
					o.mapColor  ?	sty.f=o.mapColor  : sty.f=o.color;			
					o.mapEdge   ?	sty.s=o.mapEdge   : sty.s=o.edge;				
					o.mapSize   ?	sty.w=o.mapSize   : sty.w=o.size;				
					o.mapTextCol  ? sty.tc=o.mapTextCol  : sty.tc=sd.mapTextCol;				
					o.mapTextFont ? sty.tf=o.mapTextFont : sty.tf=sd.mapTextFont;				
					o.mapOpacity  ? sty.a=o.mapOpacity   : sty.a=o.opacity;				
					mps.AddMarkerLayer(o.where,sty,i,s,e);					// Add marker to overlays
					}
			}
		}

		mps.SetBaseMap(sd.baseMap);											// Set basemap layer
		tln.InitTimeline("bottomDiv",sd);									// Initialize timeline
		mps.MarkerLayerToTop();												// Make marker layer the top-most layer

var str="<img src='http://www.viseyes.org/efolio/declaration.JPG' width='100%'> &nbsp; ";
str+=MakeSelect("testing",false,["0","1","2","3","4"]);
$("#rightDiv").html(str);
$("#testing").on("change", function() {
	var i=$(this).val();
	if (i == 1)	mps.StyleKMLFeatures(1,[{n:5,f:"#ff0000",a:.2,s:"#00ff00",w:50}]);
	if (i == 2)	mps.StyleKMLFeatures(1,[{n:5,f:"#0000ff"},{n:4,f:"#ffff00"}]);
	if (i == 3)	mps.StyleKMLFeatures(1,[{n:"*",f:"#ff00ff"}]);
	if (i == 3)	mps.StyleKMLFeatures(1,[{n:"*",f:"#ff00ff"}]);
	if (i == 4) pop.GetTextBox("Marker","Type shape","", function(str) {
							mps.StyleMarker([0],{m:str,w:35,t:"OK",f:"#0000ff"});
							}); 
$(this).val(0)
	});



	}
		

	function Draw(time)														// DRAW PROJECT
	{
		mps.UpdateMap(time,sd.timeFormat);										// Update map layers
	}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// EVENTS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	$(document).ready(function() {												// When loaded
		var i;
		if (window.addEventListener) 											// If supported this way
			window.addEventListener("message",shivaEventHandler,false);			// Add event handler
		else																	// Use other method
			window.attachEvent("message",shivaEventHandler);					// Add handler
		
		isMobile=navigator.userAgent.match(/(ipad|iphone|ipod|android)/i) ? true : false; // Set mobile flag
		var url=window.location.search.substring(1);							// Get query string
		drupalMan=(""+url).match(/pr=d/);										// If called from Drupal manager
		if (!url)																// Nothing on command line
			url=1;																// Use default
		if (drupalMan)	url="";													// If drupal, kill url
		if (url && !isNaN(url)) {												// If a number
			curShow=url;														// Save show number											
			url="//qmediaplayer.com/loadshow.php?id="+url;						// Get from db
			}	
		else if ((url) && (!url.match(/\./)))									// No file extension
			url+=".json";														// Add txt
//		$.ajax({ url: url, dataType:'jsonp' });									// Get jsonp and call LoadShow() from it

		$("#lrSiz").draggable({												// DRAG L-R WIDTH HANDLER
			cursorAt:{left:16},	iframeFix:true,									// Cursor offset
			cursor: "col-resize", axis:"x",										// X-only
			start: function(event, ui) {										// On drag start
				$("#lrSiz1").css({ width:"500px", left:"-500px" });				// Widen hiding div
				},
			drag: function(event, ui) {											// On drag
				var wid=$("#showDiv").width();									// Max width
			 	sd.leftRightSplit=Math.max(0,Math.min(1,(event.clientX-8)/wid));// Set ratio between windows
				if (Math.abs(sd.leftRightSplit-.66) < .015) 					// If close to center
					sd.leftRightSplit=.66;										// Snap it there
				ResizePanes();													// Resize panes
				},
			stop: function(event, ui) {											// On drag end
				$("#lrSiz1").css({ width:"40px", left:"-8px" });				// Contract hiding div
				ResizePanes();													// Resize panes
				}
			});
			
		$("#bSiz").draggable({												// DRAG TRANSCRIPT HEIGHT HANDLER		
			cursor: "row-resize", axis:"y",										// Y-only
			stop: function(event, ui) {											// When done
				ResizePanes;													// Resize panes when done
				},
			drag: function(event, ui) {											// On drag
				var hgt=$("#showDiv").height();									// Max height
			 	sd.upDownSplit=Math.max(0,Math.min(1,(event.clientY-8)/hgt));	// Set ratio between windows
				if (Math.abs(sd.upDownSplit-.75) < .015) 						// If close to center
					sd.upDownSplit=.75;											// Snap it there
				ResizePanes();													// Resize panes
				}
			});
		$("#lrSiz").hover(														// L-R width
			function(){ $(this).css("background-color","#acc3db")},				// Highlight
			function(){ $(this).css("background-color","transparent")			// Hide
			});
		
		$("#bSiz").hover(														// Bottom height
			function(){ $(this).css("background-color","#acc3db")},				// Highlight
			function(){ $(this).css("background-color","transparent")			// Hide
			});
	
		$("#splashDiv").delay(1000).animate({ opacity:0},500);					// Hide logo
		$("#showDiv").animate({ opacity:1},5000, function() {					// Show interface
				ResizePanes();													// Resize panes


mps.Goto("-80.00,38.41,1500")

				});				
		$(window).resize(ResizePanes);											// Dynamic resizing
		pop=new Popup("leftDiv");												// Alloc popup module
		mps=new Space("leftDiv",pop);											// Alloc map module
		tln=new Timeline(pop);													// Alloc time module
		dtl=new DataLoad();														// Alloc data module
		mps.InitMap();															// Init map
		InitProject();															// Init project
		ResizePanes();															// Resize panes
		if (drupalMan) 															// If called from Drupal manager
			window.parent.postMessage("ShivaReady=true","*");					// Send message to parent wind		

	});

	function SendShivaMessage(src, msg) 									// SEND SHIVA MESSAGE 
	{
		var str=src;															// Add src and window						
		if (msg)																// If more to it
			str+="|"+msg;														// Add it
		if (window.parent)														// If has a parent
			window.parent.postMessage(str,"*");									// Send message to parent wind
		else																	// Local	
			window.postMessage(str,"*");										// Send message to wind
	}

	function shivaEventHandler(e)											// ON SHIVA EVENT
	{
//		trace(e.data);
		if (e.data && e.data.match(/Space=/)) {									// If a space event
			var v=e.data.split("|");											// Split into parts
			if (e.data.match(/=time/))											// Set time
				tln.Goto(v[1]);													// Move timeline
			}
		else if (e.data && e.data.match(/Time=/)) {								// If a time event
			var v=e.data.split("|");											// Split into parts
			if (e.data.match(/=where/))											// Set position
				mps.Goto(v[1])													// Move map
			else if (e.data.match(/=time/))										// New time
				Draw(v[1])														// Redraw
			else if (e.data.match(/=show/))	{									// Set position
				var i;
				var mode=v[2];													// Get mode
				v=v[1].split(",");												// Get array of ids
				for (i=0;i<v.length;++i)										// For each one spec'd
					v[i]=FindMobByID(v[i]);										// Convert to mob index
				mps.DrawMapLayers(v,mode)										// Show markers(s)
				}
		}	
	}

	$("#settingsBut").click(function(e) {										// SETTINGS BUTTON CLICK
		pop.Sound("click",sd.muteSound);										// Click sound							
		var str="<table><tr height='18'>";
		str+="<tr><td>Mute clicks?</td><td><input id='setmute' type='checkbox'></td></tr>";
		str+="<tr><td>Spreadsheet</td><td><input id='setsheet' class='ve-is' style='width:220px' type='input'></td></tr>";
		str+="<tr><td>Base&nbsp;Layer </td><td>";
		str+=MakeSelect("setbase",false,["Satellite","Terrain","Earth","Watercolor","B&W","Roadmap"],sd.baseMap);
		str+="<tr><td>L-R split&nbsp;% </td><td>";
		str+="<input id='setlr' class='ve-is' style='width:30px' type='input'>&nbsp;&nbsp;&nbsp;U-D&nbsp;split&nbsp;%  ";
		str+="<input id='setud' class='ve-is' style='width:30px' type='input'></td></tr>";
		str+="<tr><td>Label&nbsp;color</td><td><input id='setstcol' class='ve-is' style='width:50px' type='input'></td></tr>";
		str+="<tr><td>Label&nbsp;font</td><td><input id='setstfont' class='ve-is' style='width:160px' type='input'></td></tr>";
		str+="<tr><td>Start/end </td><td>";
		str+="<input id='setstart' class='ve-is' style='width:70px' value='"+sd.start+"' type='input'>&nbsp;to&nbsp;";
		str+="<input id='setend' class='ve-is' style='width:70px' value='"+sd.end+"' type='input'></td></tr>";
		str+="<tr><td>Date format </td><td>";
		str+=MakeSelect("settime",false,["Year","Mo/Year","Mon Year","Mo/Day/Year","Mon Day, Year"],sd.timeFormat)+"</td></tr>";

		str+="<tr><td>Location</td><td><input id='setwhere' class='ve-is' style='width:220px' type='input'></td></tr>";
		str+="<tr><td></td><td><br><button id='setsave' class='ve-bs' title='Save project'>Save</button>&nbsp;&nbsp;&nbsp;&nbsp;<button title='Load project' id='setload' class='ve-bs'>Load</button>";
		str+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
		str+="<a href='https://docs.google.com/document/d/161td5ZuqKqT5R5r9z1P8AxBA6l9LaP-eYl_RvCyvw2g/edit?usp=sharing' target='_blank'>"
		str+="<img src='img/helpicon.gif' style='vertical-align:bottom' title='Show help'></a></td></tr>";
		str+="</table>";
		pop.Dialog("VisualEyes settings",str, function() {
				sd.mapTextCol=$("#setstcol").val();								// Set map label color
				sd.mapTextFont=$("#setstfont").val();							// Set map label font
				sd.start=$("#setstart").val();									// Set start
				sd.leftRightSplit=$("#setlr").val()/100;						// Set lr split
				sd.upDownSplit=$("#setud").val()/100;							// Set ud split
				sd.end=$("#setend").val();										// Set end
				sd.sheet=$("#setsheet").val();									// Set sheet
				tln.timeFormat=sd.timeFormat=$("#settime").val();				// Get timeformat
				sd.baseMap=$("#setbase").val();									// Get base
				mps.SetBaseMap(sd.baseMap);										// Set basemap layer
				sd.muteSound=$("#setmute").prop("checked");						// Set mute
				tln.timeFormat=mps.muteSound=sd.muteSound;						// Set all modules for mute
 				tln.InitTimeline();												// Update timeline
 				ResizePanes();													// Re draw panes
  				if (sd.sheet) {
   					sd.sheet="https://docs.google.com/spreadsheets/d/1m5N--o7W0ifmyzVm_M6F73SfFiPfvo3Prit1SWR9cb8/edit?usp=sharing";
	  			 	dtl.GetSpreadsheet(sd.sheet,true,null,function(data) {		// Get spreadsheet data
						sd.mobs=data;											// Set mobs
						InitProject(sd);										// Update timeline
						},true);
	 				}
				});		
		$("#setbase").val(sd.baseMap);											// Set base
		$("#settime").val(sd.timeFormat);										// Set timeformat
		$("#setstart").val(sd.start);											// Set start
		$("#setend").val(sd.end);												// Set end
		$("#setstcol").val(sd.mapTextCol);										// Set map label color
		$("#setstfont").val(sd.mapTextFont);									// Set map label dont
		$("#setsheet").val(sd.sheet);											// Set spreadsheet
		$("#setlr").val(Math.floor(sd.leftRightSplit*100));						// Set lr split
		$("#setud").val(Math.floor(sd.upDownSplit*100));						// Set ud split
		pop.ColorPicker("setstcol",-1,true);									// Init color
	
		$("#setbase").on("change", function(e) {								// BASE HANDLER
			mps.SetBaseMap($("#setbase").val());								// Set basemap layer
			}); 

		$("#setstcol").on("click", function(e) {								// LAB COLOR HANDLER
			pop.ColorPicker("setstcol",-1);										// Set label text color
			}); 
		});																		// End settings


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}


	function FindMobByID(id)												// FIND MOB BY ITS ID
	{
		var i,o;
		var n=sd.mobs.length;													// Get length
		for (i=0;i<n;++i) {														// For each mob
			o=sd.mobs[i].id;													// Get id												
			if (o && o.indexOf(id) != -1)										// If it matches
				return i;														// Return index of mob
			}
		return -1;																// Return nothing found
	}

	function MakeSelect(id, multi, items, sel, extra, values)				// CREATE HTML SELECT
	{
		var	str="<select class='ve-bs' id='"+id+"'";							// Header
		if (multi)																// Multi select
			str+="multiple='multiple' size='"+multi+"'";						// Add flag
		if (extra)																// If extra param
			str+=extra;															// Add them
		str+=">";																// End header
		for (i=0;i<items.length;++i) {											// For each option
			str+="<option";														// Add tag
			if (sel == items[i])												// If selected
				str+=" selected='selected'"										// Add tag
			if (values && values[i])											// If has a value
				str+=" value='"+values[i]+"'";									// Add it
			str+=">"+items[i]+"</option>";										// End option
			}	
		return str+"</select>";													// End select				
	}

	function tim(time)
	{
		return pop.FormatTime(time,"Mo/Day/Year");
	}

</script>
</body></html>

